<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFHS HS Patient Demographic Survey</title>
    <!-- Bootstrap CSS -->
    <link href="./resources/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery UI for text suggestions -->
    <link rel="stylesheet" href="./resources/css/jquery-ui.css">
    <link href="./resources/css/custom.css" rel="stylesheet">
    <link href="./resources/img/hfhs.ico" rel="shortcut icon">
</head>
<datalist id="states">
    <option value="AL">
    <option value="AK">
    <option value="AZ">
    <option value="AR">
    <option value="CA">
    <option value="CO">
    <option value="CT">
    <option value="DE">
    <option value="FL">
    <option value="GA">
    <option value="HI">
    <option value="ID">
    <option value="IL">
    <option value="IN">
    <option value="IA">
    <option value="KS">
    <option value="KY">
    <option value="LA">
    <option value="ME">
    <option value="MD">
    <option value="MA">
    <option value="MI">
    <option value="MN">
    <option value="MS">
    <option value="MO">
    <option value="MT">
    <option value="NE">
    <option value="NV">
    <option value="NH">
    <option value="NJ">
    <option value="NM">
    <option value="NY">
    <option value="NC">
    <option value="ND">
    <option value="OH">
    <option value="OK">
    <option value="OR">
    <option value="PA">
    <option value="RI">
    <option value="SC">
    <option value="SD">
    <option value="TN">
    <option value="TX">
    <option value="UT">
    <option value="VT">
    <option value="VA">
    <option value="WA">
    <option value="WV">
    <option value="WI">
    <option value="WY">
</datalist>

<body>

    <div class="container mt-5">
        <h2>HS Patient Demographic Survey</h2>
        <form id="dataForm">
            <!-- Text Box -->
            <div class="row">
                <div class="form-group col-4">
                    <label for="disease_state">Enrollment Number</label>
                    <div class="row">
                        <!-- Disease select (10% width) -->
                        <div class="col-5">
                            <select class="form-control" id="disease_state" name="disease_state" required>
                                <option value="HS">HS</option>
                                <option value="HC">HC</option>
                            </select>
                        </div>
                        <p>-</p>
                        <!-- Other input (20% width) -->
                        <div class="col-5">
                            <input type="text" class="form-control" name="enrollment_number" id="enrollment_number"
                                required>
                        </div>
                    </div>
                </div>

                <div class="form-group col-8 ml-auto">
                    <div class="row justify-content-end">
                        <div class="col-5">
                            <div class="form-group" style="text-align: right;">
                                <label class="d-block">Sample Type</label>
                                <div class="d-flex justify-content-between sample-check">
                                    <div class="form-check">
                                        <label class="form-check-label sample-check">
                                            <input type="checkbox" id="blood_checked" name="sample_type" value="Blood">
                                            Blood
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <label class="form-check-label sample-check">
                                            <input type="checkbox" id="saliva_checked" name="sample_type"
                                                value="Saliva"> Saliva
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <label class="form-check-label sample-check">
                                            <input type="checkbox" id="tissue_checked" name="sample_type"
                                                value="Tissue"> Tissue
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="form-group row justify-content-end ml-auto" id="blood_tubes" style="display:none">
                <div class="col-2 d-flex align-items-center justify-content-end" id="green_tube_container">
                    <label for="green_tube" class="mr-2" style="text-align: right">G</label>
                    <select type="number" class="form-control" name="green_tube" id="green_tube" value="0" required>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>

                <div class="col-2 d-flex align-items-center justify-content-end" id="red_tube_container">
                    <label for="red_tube" class="mr-2" style="text-align: right">R</label>
                    <select type="number" class="form-control" name="red_tube" id="red_tube" value="0" required>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
                <div class="col-2 d-flex align-items-center justify-content-end" id="purple_tube_container">
                    <label for="purple_tube" class="mr-2" style="text-align: right">P</label>
                    <select type="number" class="form-control" name="purple_tube" id="purple_tube" value="0" required>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-3">
                        <label for="collection_site">Collection Site</label>
                        <select class="form-control" id="collection_site" name="collection_site" required>
                            <option value="" disabled selected>Enter Site</option>
                            <option value="hamzavi_clinic">Hamzavi Clinic</option>
                            <option value="new_center_one">New Center One</option>
                            <option value="wayne">WSU</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Collector Name</label>
                <div class="row">
                    <div class="col-4">
                        <input type="text" class="form-control" name="col_first_name" id="col_first_name"
                            placeholder="First Name" required>
                    </div>
                    <div class="col-4">
                        <input type="text" class="form-control" name="col_last_name" id="col_last_name"
                            placeholder="Last Name" required>
                    </div>
                </div>
            </div>

            <br>
            <label class="h4">Patient Basic Demographic Data</label>
            <hr style="border: none; border-top: 1px solid black; margin: 0 0 10px 0">
            <div class="form-group">
                <label for="mrn">MRN</label>
                <input type="text" class="form-control" name="mrn" id="mrn" required>
            </div>
            <div class="form-group">
                <label for="sex">Sex</label>
                <select class="form-control" id="sex" name="sex" required>
                    <option value="" disabled selected>Enter Sex</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            </br>
            <label class="h4">Lesion Location Counts</label>
            <hr style="border: none; border-top: 1px solid black; margin: 0 0 10px 0">
            <div class="form-group">
                <div class="row">
                    <div class="col-5">
                        <table class="table" id="lesion_table">
                            <thead>
                                <tr>
                                    <th>Lesion Location</th>
                                    <th>Number of Lesions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Axillae</td>
                                    <td><input type="number" id="axillae" name="axillae" class="form-control number-box"
                                            placeholder="0" min="0" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Mammary</td>
                                    <td><input type="number" id="mammary" name="mammary" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Other Upper</td>
                                    <td><input type="number" id="other_upper" name="other_upper"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Buttocks</td>
                                    <td><input type="number" id="buttocks" name="buttocks"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Genital</td>
                                    <td><input type="number" id="genital" name="genital" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Other Lower</td>
                                    <td><input type="number" id="other_lower" name="other_lower"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>

                                <tr>
                                    <td><u>HS-IGA Score</u></td>
                                    <td><input type="number" id="hs-iga" name="hs-iga" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td><u>IHS4 Score</u></td>
                                    <td><input type="number" id="ihs4" name="ihs4" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td><u>HS-PGA Score</u></td>
                                    <td><input type="number" id="pga" name="pga" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>

                            </tbody>
                        </table>
                        <button id="clear_body_map" type="button" class="btn btn-danger">Clear Lesion Counts</button>
                        <button id="clear_last_lesion" type="button" class="btn btn-secondary">Undo</button>
                    </div>
                    <div class="col-5">
                        <div style="position: relative;">
                            <canvas id="body_map" style="display: block; border: none;"></canvas>
                            <canvas id="lesion_map"
                                style="display: block; position: absolute; top: 0; left: 0;"></canvas>
                        </div>
                        <div style="display: none; justify-content: center; margin-top: 10px;" id="drawing_buttons">
                            <button class="btn btn-outline-secondary" style="flex: 3.5; margin-right: 5px;"
                                id="inf_nodule_button">Inflamm. Nodule</button>
                            <button class="btn btn-outline-secondary" style="flex: 3.5; margin-right: 5px;"
                                id="non-inf_nodule_button">Non-Inflamm. Nodule</button>
                            <button class="btn btn-outline-secondary" style="flex: 1; margin-right: 5px;"
                                id="abcess_button">Abcess</button>
                            <button class="btn btn-outline-secondary" style="flex: 2.5; margin-right: 5px;"
                                id="draining_tunnel_button">Draining
                                Tunnel</button>
                            <button class="btn btn-outline-secondary" style="flex: 3.5;"
                                id="non-draining_tunnel_button">Non-Draining Tunnel</button>
                        </div>
                    </div>
                </div>

            </div>
            <br>
            <label class="h4">Family History</label>
            <hr style="border: none; border-top: 1px solid black; margin: 0 0 10px 0">
            <div class="form-group">
                <label class="form-label">Does the patient have a family history of HS?</label>
                <div class="form-check">
                    <input type="radio" id="family_history_yes" class="form-check-input" name="family_history"
                        value="yes" required>
                    <label class="form-check-label" for="family_history_yes">Yes</label>
                </div>
                <div class="form-check">
                    <input type="radio" id="family_history_no" class="form-check-input" name="family_history"
                        value="no">
                    <label class="form-check-label" for="family_history_no">No</label>
                </div>
                <div class="form-check">
                    <input type="radio" id="family_history_unknown" class="form-check-input" name="family_history"
                        value="unknown">
                    <label class="form-check-label" for="family_history_unknown">Unknown</label>
                </div>
            </div>
            <div class="form-group" id="family_parent" style="display: none;">
                <div id="familyContainer" style="display: none;">
                    <label class="form-label" id="family_title"><u>Family Member 1:</u></label>
                    <div class="form-group">
                        <label>Relation</label>
                        <input type="text" class="form-control" id="familyRelation" placeholder="Relation to Patient">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Have we already collected a sample from this relation?</label>
                        <div class="form-check">
                            <input type="radio" id="family_collect_yes" class="form-check-input" name="family_collect"
                                value="yes">
                            <label class="form-check-label" for="family_collect_yes">Yes</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="family_collect_no" class="form-check-input" name="family_collect"
                                value="no">
                            <label class="form-check-label" for="family_collect_no">No</label>
                        </div>
                    </div>
                    <!-- if have -->

                    <div class="form-group" id="relation_id" style="display: none">
                        <label>Relation Enrollment Number </label>
                        <div style="display: flex; align-items: center;">
                            <span>HS - </span> <!-- Text "HS - " -->
                            <div class="col-2">
                                <input type="text" class="form-control" name="relation_enrollment_number"
                                    id="relation_enrollment_number">
                            </div>
                        </div>
                    </div>

                    <!-- if haven't collected information -->
                    <div id="new_relation_info" style="display: none">
                        <div class="form-group">
                            <label>Name</label>
                            <div class="row">
                                <div class="col-4">
                                    <input type="text" class="form-control" name="rel_first_name" id="rel_first_name"
                                        placeholder="First Name">
                                </div>
                                <div class="col-4">
                                    <input type="text" class="form-control" name="rel_last_name" id="rel_last_name"
                                        placeholder="Last Name">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="familyEmail">Email</label>
                            <input type="email" class="form-control" id="familyEmail" placeholder="Email">
                        </div>
                        <div class="form-group">
                            <label for="familyPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="familyPhone" placeholder="Phone Number"
                                pattern="[0-9]{3}[0-9]{3}[0-9]{4}">
                            <small class="form-text text-muted">Format: 1234567890</small>
                        </div>
                        <div class="form-group">
                            <label for="familyAddress">Address</label>
                            <input type="text" class="form-control" id="familyAddress" placeholder="1234 Main St">
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="familyCity">City</label>
                                <input type="text" class="form-control" id="familyCity">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="familyState">State</label>
                                <input list="states" id="familyState" name="familyState" class=form-control>
                            </div>
                            <div class="form-group col-md-2">
                                <label for="familyZip">Zip</label>
                                <input type="text" class="form-control" id="familyZip">
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="familyNotes">Notes</label>
                        <input type="text" class="form-control" id="familyNotes" name="familyNotes">
                    </div>
                    <button type="button" class="addRelative btn btn-primary" style="margin-top: 10px;">Add Another
                        Relative</button>
                    <hr style="border: none; border-top: 1px solid black; margin: 20px 0">
                </div>

            </div>

            <!-- Text Box with Suggestions -->
            <div class="form-group">
                <label for="other_notes">Other Notes</label>
                <input type="text" class="form-control" id="other_notes" name="other_notes"
                    placeholder="Type something...">
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
            <br>
            <br>
        </form>
    </div>

    <!-- jQuery, Bootstrap JS, and jQuery UI -->
    <script src="./resources/js/jquery-3.5.1.min.js"></script>
    <script src="./resources/js/jquery-ui.min.js"></script>
    <script src="./resources/js/bootstrap.min.js"></script>
    <script src="./resources/js/crypto-js.min.js"></script>

    <!-- load medicines list -->
    <script src="./resources/js/constants.js"></script>

    <!-- hidden questions -->
    <script>
        const family_container_base = document.getElementById('familyContainer').innerHTML;
        const debug = false;
        const bloodChecked = document.getElementById('blood_checked');
        const salivaChecked = document.getElementById('saliva_checked');
        const tissueChecked = document.getElementById('tissue_checked');
        const familyContainer = document.getElementById('familyContainer');
        const familyCheckbox = document.getElementById('family_history');
        const sexBox = document.getElementById('sex');
        const canvas = document.getElementById('body_map');
        const ctx = canvas.getContext("2d");
        const relation_id = document.getElementById('relation_id');
        const new_relation_info = document.getElementById('new_relation_info');
        const family_parent = document.getElementById('family_parent');

        const lesion_canvas = document.getElementById('lesion_map');
        const ltx = lesion_canvas.getContext("2d");

        const lesionTable = document.getElementById('lesion_table');

        const family_radios = document.querySelectorAll('input[name="family_history"]');
        const family_collect_radios = document.querySelectorAll('input[name="family_collect"]');
        const bloodContainer = document.getElementById("blood_tubes");
        const lesion_undo = document.getElementById("clear_last_lesion");
        const drawing_buttons = document.getElementById("drawing_buttons");
        let point_style;
        let bodyImage;
        let number_of_relations = 0;

        // [non inf nodules, inf nodules, abcess, draining tunnel, non-draining tunnel]
        let lesiontypesdict = {
            "axillae": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
            "mammary": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
            "genital": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
            "buttocks": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
            "other_upper": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
            "other_lower": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 }
        };
        let lesioncountsdict = { "axillae": 0, "mammary": 0, "genital": 0, "buttocks": 0, "other_upper": 0, "other_lower": 0 };
        let gender;

        let upper_total;
        let lower_total;
        let polygon_dict = {};
        let allowdraw = false;

        // get rid of required for everything if debug
        if (debug) {
            const formFields = document.querySelectorAll('#dataForm [required]');

            // arrow func implicit return, function(field){field.removeAttribute();}
            // array.forEach(callback_function_applied(currentValue, index, array), thisArg);
            /*if (debug) {
                const formFields = document.querySelectorAll('#dataForm [required]');
                const context = { prefix: 'Field: ' };

                formFields.forEach(function(field) {
                    console.log(this.prefix + field.name);
                    field.removeAttribute('required');
                }, context);

                submit_form();
                return;
            }*/
            formFields.forEach(field => field.removeAttribute('required'));
        }

        function appendFamilyContainer() {
            let new_family_container = document.createElement('div');
            number_of_relations++;
            console.log(number_of_relations);
            new_family_container.id = 'familyContainer' + number_of_relations;
            new_family_container.innerHTML = family_container_base;

            // change title of new section
            new_family_container.querySelector('#family_title').innerHTML = '<u>Family Member ' + number_of_relations + ':</u>';

            // update ids and names
            new_family_container.querySelector('#familyRelation').id = 'familyRelation' + '_' + number_of_relations;
            new_family_container.querySelector('#family_collect_yes').id = 'family_collect_yes' + '_' + number_of_relations;
            new_family_container.querySelector('#family_collect_yes' + '_' + number_of_relations).name = 'family_collect' + '_' + number_of_relations;
            new_family_container.querySelector('#family_collect_no').id = 'family_collect_no' + '_' + number_of_relations;
            new_family_container.querySelector('#family_collect_no' + '_' + number_of_relations).name = 'family_collect' + '_' + number_of_relations;


            new_family_container.querySelector('#relation_id').id = 'relation_id' + '_' + number_of_relations;
            new_family_container.querySelector('#relation_enrollment_number').id = 'relation_enrollment_number' + '_' + number_of_relations;
            new_family_container.querySelector('#new_relation_info').id = 'new_relation_info' + '_' + number_of_relations;
            new_family_container.querySelector('#rel_first_name').id = 'rel_first_name' + '_' + number_of_relations;
            new_family_container.querySelector('#rel_last_name').id = 'rel_last_name' + '_' + number_of_relations;
            new_family_container.querySelector('#familyEmail').id = 'familyEmail' + '_' + number_of_relations;
            new_family_container.querySelector('#familyPhone').id = 'familyPhone' + '_' + number_of_relations;
            new_family_container.querySelector('#familyAddress').id = 'familyAddress' + '_' + number_of_relations;
            new_family_container.querySelector('#familyCity').id = 'familyCity' + '_' + number_of_relations;
            new_family_container.querySelector('#familyState').id = 'familyState' + '_' + number_of_relations;
            new_family_container.querySelector('#familyZip').id = 'familyZip' + '_' + number_of_relations;
            new_family_container.querySelector('#familyNotes').id = 'familyNotes' + '_' + number_of_relations;

            // Append the cloned container to the form
            family_parent.appendChild(new_family_container);
        }

        // Get all drawing buttons
        const buttons = drawing_buttons.querySelectorAll('button');

        function resetButtons() {
            buttons.forEach(btn => {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-outline-secondary');
            });
        }

        // Add click event listener to each button
        buttons.forEach(button => {
            button.addEventListener('click', function (event) {
                if (!allowdraw) {
                    enableDrawing(lesion_canvas);
                }
                event.preventDefault();
                resetButtons();

                // Change clicked button to btn-outline-secondary
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-secondary');
                // Get the text content of the clicked button
                const buttonId = event.target.id;
                console.log(buttonId);

                // Perform action based on which button was clicked
                switch (buttonId) {
                    case 'inf_nodule_button':
                        point_style = "Inflammatory Nodule";
                        break;
                    case 'non-inf_nodule_button':
                        point_style = "Non-Inflammatory Nodule";
                        break;
                    case 'abcess_button':
                        console.log('Abcess button clicked');
                        point_style = "Abcess";
                        break;
                    case 'draining_tunnel_button':
                        console.log('Draining Tunnel button clicked');
                        point_style = "Draining Tunnel";
                        break;
                    case 'non-draining_tunnel_button':
                        console.log('Non-Draining Tunnel button clicked');
                        point_style = "Non-Draining Tunnel";
                        break;
                    default:
                        // should not happen
                        console.log('Unknown button clicked');
                }
            });
        });
        let prev_num_relations = -1;
        family_radios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'yes') {
                    family_parent.style.display = 'block';
                    familyContainer.style.display = 'block'; // Show pack history input if "Yes" is selected
                    if (prev_num_relations != -1) {
                        number_of_relations = prev_num_relations;
                    }
                    else {
                        number_of_relations = 1;
                    }
                } else {
                    family_parent.style.display = 'none';
                    familyContainer.style.display = 'none'; // Hide it if "No" or "Unknown" is selected
                    if (number_of_relations != 0) {
                        prev_num_relations = number_of_relations;
                    }
                    number_of_relations = 0;
                }
                console.log(number_of_relations);
            });
        });


        // add event delegator for the family buttons
        function canBeInt(str) {
            // Trim whitespace from the string and attempt to parse it as an integer
            const parsed = parseInt(str, 10);
            // Check if the parsed value is a number and equals the original string when converted to string
            return !isNaN(parsed) && parsed.toString() === str;
        }

        family_parent.addEventListener('click', function (event) {
            // parent family_collect listener
            if (event.target.name == 'family_collect') {
                if (event.target.value === 'yes') {
                    document.getElementById('relation_id').style.display = 'block';
                    document.getElementById('new_relation_info').style.display = 'none';
                } else {
                    document.getElementById('relation_id').style.display = 'none';
                    document.getElementById('new_relation_info').style.display = 'block';
                }
                return;
            }

            // Add event listener for the initial "Add Another Relative" button
            if (event.target.classList.contains('addRelative')) {
                event.target.remove();
                appendFamilyContainer();
                return;
            };

            // get event target relation number
            let target_id = event.target.id;

            // if target id is undefined
            if (!target_id) {
                console.log("target id is undefined");
                return;
            }
            let relation_number = target_id.split('_')[target_id.split('_').length - 1].trim();
            if (!canBeInt(relation_number)) {
                console.log(target_id);
                console.log("invalid relation number");
                return;
            }

            // children family_collect listener
            if (event.target.name.startsWith('family_collect')) {
                if (event.target.value === 'yes') {
                    document.getElementById('relation_id' + '_' + relation_number).style.display = 'block';
                    document.getElementById('new_relation_info' + '_' + relation_number).style.display = 'none';
                } else {
                    document.getElementById('relation_id' + '_' + relation_number).style.display = 'none';
                    document.getElementById('new_relation_info' + '_' + relation_number).style.display = 'block';
                }
            }
        });


        bloodChecked.addEventListener('change', function () {
            if (this.checked) {
                bloodContainer.style.display = 'flex';
            }
            else {
                bloodContainer.style.display = 'none';
            }
        });


        function drawImage(gender_) {
            // might need to adjust for tablet
            bodyImage = new Image(600, 554);
            canvas.height = lesion_canvas.height = bodyImage.height;
            canvas.width = lesion_canvas.width = bodyImage.width;

            // change buttons to match
            drawing_buttons.style.width = canvas.offsetWidth + 'px';

            bodyImage.onload = drawImageActualSize;
            if (gender_ == "male") {
                bodyImage.src = "./resources/img/male-iga.png";
            }
            if (gender_ == "female") {
                bodyImage.src = "./resources/img/female-iga.png";
            }
        }

        function drawImageActualSize() {
            ctx.drawImage(this, 0, 0, this.width, this.height);
            drawPolygons();
            canvas.style.border = '2px solid black';
        }

        sexBox.addEventListener('change', function () {
            console.log("changed sex");
            var tableHeight = lesionTable.offsetHeight;
            drawing_buttons.style.display = "flex";
            if (this.value.trim().toLowerCase() == "male" || this.value.trim().toLowerCase() == "other") {
                console.log("male");
                clearCounts();
                gender = "male";
                drawImage(gender);
            }
            else if (this.value.trim().toLowerCase() == "female") {
                console.log("female");
                gender = "female";
                clearCounts();
                drawImage(gender);
            }
            else {
                return;
            }
            disableDrawing(lesion_canvas);

        });

        function drawPolygon(points, key) {
            ctx.beginPath();
            ctx.moveTo(points[0][0], points[0][1]);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i][0], points[i][1]);
            }
            ctx.closePath();

            if (key.startsWith("Axillae")) {
                ctx.fillStyle = "rgba(127,128,0,0.5)"
            }
            if (key.startsWith("Genital")) {
                ctx.fillStyle = "rgba(255,0,0,0.5)"
            }
            if (key.startsWith("Buttocks")) {
                ctx.fillStyle = "rgba(28,144,255,0.5)"
            }
            if (key.startsWith("Mammary")) {
                ctx.fillStyle = "rgba(50,255,0,0.5)"
            }
            ctx.fill();
            ctx.stroke();

        }

        // Function to draw all polygons on the canvas
        async function drawPolygons() {
            if (gender == "male") {
                for (const key in male_polygons) {
                    drawPolygon(male_polygons[key], key);
                }
            }
            if (gender == "female") {
                for (const key in female_polygons) {
                    drawPolygon(female_polygons[key], key);
                }
            }
        }

        // Point-in-polygon function
        function isPointInPolygon(point, polygon) {
            let x = point[0], y = point[1];
            let inside = false;

            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];

                const intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        // Update counters on the page
        function updateCounters() {
            document.getElementById("axillae").value = lesioncountsdict["axillae"];
            document.getElementById("mammary").value = lesioncountsdict["mammary"];
            document.getElementById("buttocks").value = lesioncountsdict["buttocks"];
            document.getElementById("genital").value = lesioncountsdict["genital"];
            document.getElementById("other_lower").value = lesioncountsdict["other_lower"];
            document.getElementById("other_upper").value = lesioncountsdict["other_upper"];
            upper_total = lesioncountsdict["other_upper"] + lesioncountsdict["mammary"] + lesioncountsdict["axillae"];
            lower_total = lesioncountsdict["other_lower"] + lesioncountsdict["genital"] + lesioncountsdict["buttocks"];
            document.getElementById("hs-iga").value = hs_iga_scr(Math.max(upper_total, lower_total));
            document.getElementById("ihs4").value = ihs4_scr(lesiontypesdict);
            document.getElementById("pga").value = pga_scr(lesiontypesdict);
        }

        const lesion_body_parts = [];
        // Check which body part is clicked based on coordinates
        function checkBodyPart(x, y) {
            let output_key;
            let lower_region;
            const point = [x, y];
            var validpoint = false;
            if (gender == "male") {
                lower_region = male_lower;
                for (const key in male_polygons) {
                    if (isPointInPolygon(point, male_polygons[key])) {
                        var key_str = key.replace(/[0-9]/g, '').toLowerCase();
                        output_key = key_str;
                        validpoint = true;
                        break;
                    }
                }
            }
            if (gender == "female") {
                lower_region = female_lower;
                for (const key in female_polygons) {
                    if (isPointInPolygon(point, female_polygons[key])) {
                        var key_str = key.replace(/[0-9]/g, '').toLowerCase();
                        output_key = key_str;
                        validpoint = true;
                        break;
                    }
                }
            }
            if (!validpoint) {
                // check if point is in upper or lower body
                if (isPointInPolygon(point, lower_region[0]) || isPointInPolygon(point, lower_region[1])) {
                    output_key = "other_lower";
                }
                else {
                    output_key = "other_upper";
                }
            }
            lesion_body_parts.push([output_key, point_style]);
            lesioncountsdict[output_key] += 1;
            lesiontypesdict[output_key][point_style] += 1;
            updateCounters();
        }

        function clearCounts() {
            ltx.clearRect(0, 0, lesion_canvas.width, lesion_canvas.height);
            lesioncountsdict = { "axillae": 0, "mammary": 0, "genital": 0, "buttocks": 0, "other_upper": 0, "other_lower": 0 };
            lesiontypesdict = {
                "axillae": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
                "mammary": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
                "genital": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
                "buttocks": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
                "other_upper": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 },
                "other_lower": { "Non-Inflammatory Nodule": 0, "Inflammatory Nodule": 0, "Abcess": 0, "Draining Tunnel": 0, "Non-Draining Tunnel": 0 }
            };
            updateCounters();
        }

        function grayOutCanvas() {
            ltx.fillStyle = "rgba(128, 128, 128, 0.5)";  // Gray color with 50% opacity
            ltx.fillRect(0, 0, lesion_canvas.width, lesion_canvas.height);
            ltx.textAlign = "center";  // Center text horizontally
            ltx.textBaseline = "middle";
            ltx.font = "40px Arial";
            ltx.fillStyle = "white";
            ltx.fillText("Pick a Lesion Type", lesion_canvas.width / 2, lesion_canvas.height / 2);
        }

        function disableDrawing() {
            allowdraw = false;
            grayOutCanvas();
        }

        // To re-enable drawing, you would need to reassign the event handlers
        function enableDrawing() {
            allowdraw = true;
            ltx.clearRect(0, 0, lesion_canvas.width, lesion_canvas.height);
        }



        function drawPoint(x, y, ps) {
            ltx.beginPath();
            ltx.fillStyle = "black";
            ltx.strokeStyle = "black";
            if (ps == "Inflammatory Nodule") {
                ltx.arc(x, y, 2.5, 0, Math.PI * 2);
                ltx.fill();
            }
            else if (ps == "Draining Tunnel") {
                ltx.font = "15px Arial";
                ltx.fillText("=", x, y);
            }
            else if (ps == "Non-Draining Tunnel") {
                ltx.font = "12px Arial";
                ltx.fillText("≠", x, y);
            }
            else if (ps == "Non-Inflammatory Nodule") {
                ltx.arc(x, y, 2.5, 0, Math.PI * 2);
                ltx.stroke();
            }
            else if (ps == "Abcess") {
                ltx.font = "15px Arial";
                ltx.fillText("x", x, y);
            }
        }


        // javascript consts are not immutable, you just can't assign them to something else
        const lesion_points = []
        // Draw lesion point
        lesion_canvas.addEventListener("click", function (event) {
            if (allowdraw) {
                rect = lesion_canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                let body_region;

                if (gender == "male") {
                    body_region = male_region;
                }
                else {
                    body_region = female_region;
                }

                // two bodies per img
                if (!isPointInPolygon([x, y], body_region[0]) && !isPointInPolygon([x, y], body_region[1])) {
                    console.log("point not on body");
                    return;
                }

                lesion_points.push([x, y, point_style]);

                if ($("#sex").val()) {
                    // Mark the clicked point on the canvas
                    drawPoint(x, y, point_style);
                }

                // Check which body part was clicked
                checkBodyPart(x, y);
            }
        });

        function redraw_lesion_points() {
            ltx.clearRect(0, 0, lesion_canvas.width, lesion_canvas.height);
            for (const lesion of lesion_points) {
                drawPoint(lesion[0], lesion[1], lesion[2]);
            }
        }

        function undo_lesion_point() {
            if (lesion_points.length > 0) {
                lesion_points.pop();
                redraw_lesion_points();
                last_part = lesion_body_parts.pop();
                lesioncountsdict[last_part[0]] -= 1;
                lesiontypesdict[last_part[0]][last_part[1]] -= 1;
                updateCounters();

            }
        }

        document.getElementById('clear_body_map').addEventListener('click', function () {
            // Clear the body map or perform other actions
            console.log('Clear Body Map button clicked');
            // Example: Clear the canvas
            clearCounts();
        });

        lesion_undo.addEventListener('click', undo_lesion_point);

    </script>


    <!-- Submit form as JSON -->
    <script>
        const form = document.getElementById('dataForm');

        // don't auto submit with enter keypress
        document.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                console.log("enter");
                event.preventDefault(); // Prevent form submission
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey && event.key === 'z') {
                console.log("undo");
                event.preventDefault(); // Prevent default undo action
                undo_lesion_point(); // Call the undo function
            }
        });

        function submit_form() {
            let family_history_list = [];
            if (number_of_relations > 0) {
                for (let i = 1; i <= number_of_relations; i++) {
                    if (i == 1) {

                        if (document.getElementById("family_collect_yes").checked) {
                            family_history_list.push({
                                relation: document.getElementById("familyRelation").value,
                                enrollment_number: document.getElementById("relation_enrollment_number").value
                            });
                        }
                        else {
                            family_history_list.push({
                                relation: document.getElementById("familyRelation").value,
                                first_name: document.getElementById("rel_first_name").value,
                                last_name: document.getElementById("rel_last_name").value,
                                email: document.getElementById("familyEmail").value,
                                phone: document.getElementById("familyPhone").value,
                                address: document.getElementById("familyAddress").value,
                                city: document.getElementById("familyCity").value,
                                state: document.getElementById("familyState").value,
                                zip: document.getElementById("familyZip").value,
                                notes: document.getElementById("familyNotes").value
                            });
                        }
                    }
                    else {
                        if (document.getElementById("family_collect_yes" + '_' + i).checked) {
                            family_history_list.push({
                                relation: document.getElementById("familyRelation" + '_' + i).value,
                                enrollment_number: document.getElementById("relation_enrollment_number" + '_' + i).value
                            });
                        }
                        else {
                            family_history_list.push({
                                relation: document.getElementById("familyRelation" + '_' + i).value,
                                first_name: document.getElementById("rel_first_name" + '_' + i).value,
                                last_name: document.getElementById("rel_last_name" + '_' + i).value,
                                email: document.getElementById("familyEmail" + '_' + i).value,
                                phone: document.getElementById("familyPhone" + '_' + i).value,
                                address: document.getElementById("familyAddress" + '_' + i).value,
                                city: document.getElementById("familyCity" + '_' + i).value,
                                state: document.getElementById("familyState" + '_' + i).value,
                                zip: document.getElementById("familyZip" + '_' + i).value,
                                notes: document.getElementById("familyNotes" + '_' + i).value
                            });
                        }
                    }
                }

            }

            const sample_type = [];

            // Check the state of each checkbox and get its value if checked
            // Add the value to the array if the checkbox is checked
            if (bloodChecked.checked) {
                sample_type.push(bloodChecked.value);
            }
            if (salivaChecked.checked) {
                sample_type.push(salivaChecked.value);
            }
            if (tissueChecked.checked) {
                sample_type.push(tissueChecked.value);
            }

            let today = new Date();

            var formData = {
                date: today,
                disease_state: $("#disease_state").val(),
                enrollment_number: $("#enrollment_number").val(),
                collection_site: $("#collection_site").val(),
                sample_type: sample_type,
                blood_g: $("#green_tube").val(),
                blood_r: $("#red_tube").val(),
                blood_p: $("#purple_tube").val(),
                collector_name: ($("#col_first_name").val() + ' ' + $("#col_last_name").val()).toLowerCase(),
                MRN: $("#mrn").val(),
                sex: $("#sex").val(),
                obesity: $("#bmi").val() > 30,
                axillae: $("#axillae").val(),
                buttocks: $("#buttocks").val(),
                mammary: $("#mammary").val(),
                genital: $("#genital").val(),
                other_upper: $("#other_upper").val(),
                other_lower: $("#other_lower").val(),
                upper_total: upper_total,
                lower_total: lower_total,
                iga_score: $("#hs-iga").val(),
                ihs4_score: $("#ihs4").val(),
                pga_score: $("#pga").val(),
                family_history: $("#family_history").is(":checked"),
                family_contact: family_history_list,

                other_notes: $("#other_notes").val(),
                lesion_map_points: lesion_points,
                suggestionBox: $("#suggestionBox").val()
            };

            // Convert form data to JSON
            var jsonData = JSON.stringify(formData, null, 4);

            var blob = new Blob([jsonData], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            // Create a link element to trigger the download
            var a = document.createElement('a');
            a.href = url;
            if (debug) {
                a.download = `debug.json`;
            }
            else {
                a.download = $("#mrn").val() + '.json';
            } // Set the file name to MRN value
            document.body.appendChild(a); // Append to the body
            a.click(); // Trigger the download
            document.body.removeChild(a); // Remove the link


            /* issue with encryption is that secret key can only be obfuscated since
            all the code exists locally. probably not worth the hassle of having people
            use aes to decrypt vs the security benefit.
            // Display JSON in the output div
            $("#jsonOutput").text(jsonData);
     
            var secretKey = "your-secret-key"; // Replace with your secret key
            var encryptedData = CryptoJS.AES.encrypt(jsonData, secretKey).toString();
            */
        }

        // Handle form submission and convert data to JSON
        $("#dataForm").submit(function (event) {
            event.preventDefault(); // Prevent the default form submission

            if (debug) {
                submit_form();
                return;
            }

            if (!bloodChecked.checked && !salivaChecked.checked && !tissueChecked.checked) {
                alert("Please select at least one sample type.");
                return;
            }

            if (bloodChecked.checked) {
                if ($("#green_tube").val() == 0 && $("#red_tube").val() == 0 && $("#purple_tube").val() == 0) {
                    alert("Please enter the tube counts for blood samples");
                    return;
                }
            }

            var userInput = prompt("Please enter the MRN to confirm:");

            var mrnValue = $("#mrn").val();
            if (userInput !== null) { // Check if the user didn't cancel the prompt
                if (userInput.trim() === mrnValue) {
                    // If numbers match, you can proceed to submit the form or do whatever is needed
                    alert("Numbers match. Submitting the form...");
                    // Collect form data
                    submit_form();
                }
                else {
                    alert("The number you entered does not match the MRN field.");
                }
            }
            else {
                alert("You did not enter anything.");
            }
        });
    </script>

</body>

</html>