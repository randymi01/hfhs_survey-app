<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFHS HS Patient Demographic Survey</title>
    <!-- Bootstrap CSS -->
    <link href="./resources/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery UI for text suggestions -->
    <link rel="stylesheet" href="./resources/css/jquery-ui.css">
    <link href="./resources/css/custom.css" rel="stylesheet">
    <link href="./resources/img/hfhs.ico" rel="shortcut icon">
</head>

<body>

    <div class="container mt-5">
        <h2>HS Patient Demographic Survey</h2>
        <form id="dataForm">
            <!-- Text Box -->
            <div class="form-group">
                <label for="disease_state">Enrollment Number</label>
                <div class="row">
                    <!-- Disease select (10% width) -->
                    <div class="col-2">
                        <select class="form-control" id="disease_state" name="disease_state" required>
                            <option value="HS">HS</option>
                            <option value="HC">HC</option>
                        </select>
                    </div>
                    <p>-</p>
                    <!-- Other input (20% width) -->
                    <div class="col-2">
                        <input type="number" class="form-control" name="enrollment_number" id="enrollment_number"
                            min="1" max="999" required>
                    </div>
                </div>
            </div>

            <!-- Text Box -->
            <div class="form-group">
                <label for="first_name">Patient Name</label>
                <div class="row">
                    <div class="col-4">
                        <input type="text" class="form-control" name="first_name" id="first_name"
                            placeholder="First Name" required>
                    </div>
                    <div class="col-4">
                        <input type="text" class="form-control" name="last_name" id="last_name" placeholder="Last Name"
                            required>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="mrn">MRN</label>
                <input type="number" class="form-control" name="mrn" id="mrn" required>
            </div>

            <!-- Date Box -->
            <div class="form-group">
                <label for="dob">Patient Date of Birth</label>
                <input type="date" class="form-control" id="dob" name="dob" required>
            </div>

            <div class="form-group">
                <label for="race">Race</label>
                <select class="form-control" id="race" name="race" required>
                    <option value="" disabled selected>Enter Race</option>
                    <option value="african_american">African American</option>
                    <option value="caucasian">Caucasian</option>
                    <option value="asian">Asian</option>
                    <option value="hispanic">Hispanic/Latino</option>
                    <option value="native_american">Native American</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sex">Sex</label>
                <select class="form-control" id="sex" name="sex" required>
                    <option value="" disabled selected>Enter Sex</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bmi">BMI</label>
                <input type="number" class="form-control" id="bmi" name="bmi" step="0.01" min="0"
                    placeholder="Enter BMI">
            </div>

            <div class="form-group">
                <label for="hurley">Hurley Stage (Highest)</label>
                <select class="form-control" id="hurley" name="hurley" required>
                    <option value="" disabled selected>Enter Hurley Stage</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
            </br>
            <div class="form-group">
                <label>Lesion Location Counts</label>
                <div class="row">
                    <div class="col-5">
                        <table class="table" id="lesion_table">
                            <thead>
                                <tr>
                                    <th>Lesion Location</th>
                                    <th>Number of Lesions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Axillae</td>
                                    <td><input type="number" id="axillae" name="axillae" class="form-control number-box"
                                            placeholder="0" min="0" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Groin</td>
                                    <td><input type="number" id="groin" name="groin" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Buttocks</td>
                                    <td><input type="number" id="buttocks" name="buttocks"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Inframammary</td>
                                    <td><input type="number" id="inframammary" name="inframammary"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Perianal</td>
                                    <td><input type="number" id="perianal" name="perianal"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Genital</td>
                                    <td><input type="number" id="genital" name="genital" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Inner Thigh</td>
                                    <td><input type="number" id="inner_thigh" name="inner_thigh"
                                            class="form-control number-box" placeholder="0" min="0" readonly></td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td><input type="number" id="other" name="other" class="form-control number-box"
                                            placeholder="0" min="0" readonly></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-5">
                        <canvas id="body_map" style="display: hidden"> </canvas>
                    </div>
                </div>
                <button id="clear_body_map" type="button" class="btn btn-dark">Clear Lesion Counts</button>
            </div>

            <div class="form-group">
                <label for="smoking_history" class="form-label">Does the patient have a smoking history?</label>
                <div class="form-check">
                    <input type="checkbox" id="smoking_history" class="form-check-input">
                    <label class="form-check-label" for="smoking_history">Yes</label>
                </div>
                <div class="mb-3" id="packHistoryContainer" style="display: none;">
                    <label for="packHistory" class="form-label">Pack History:</label>
                    <input type="number" id="packHistory" name="pack_history" class="form-control"
                        placeholder="Packs per Day" min="0">
                </div>
            </div>

            <!-- Checkbox morbidities
            <div class="form-group">
                <label class="form-label" style="font-weight: bold">Comorbidities:</label>
                <div class="mb-3 no-bold">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="diabetes" name="comorbidities"
                            value="diabetes">
                        <label class="form-check-label" for="diabetes">Diabetes</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="obesity" name="comorbidities"
                            value="obesity">
                        <label class="form-check-label" for="obesity">Obesity</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="hypertension" name="comorbidities"
                            value="hypertension">
                        <label class="form-check-label" for="hypertension">Hypertension</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="crohns" name="comorbidities" value="crohns">
                        <label class="form-check-label" for="crohns">Crohn's Disease</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="psoriasis" name="comorbidities"
                            value="psoriasis">
                        <label class="form-check-label" for="psoriasis">Psoriasis</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="arthritis" name="comorbidities"
                            value="arthritis">
                        <label class="form-check-label" for="arthritis">Arthritis</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="otherCheckbox" name="comorbidities"
                            value="other">
                        <label class="form-check-label" for="otherCheckbox">Other</label>
                    </div>
                    <div class="mb-3" id="otherInputContainer" style="display: none;">
                        <input type="text" id="otherInput" class="form-control mt-2"
                            placeholder="Please specify (seperate conditions with ',')" name="other" />
                    </div>
                </div>
            </div>
        -->
            <div class="form-group">
                <label class="form-label" for="comorbidities">Select Comorbidities (tap to remove)</label>
                <div class="suggestions-container">
                    <input type="text" id="comorbidities" class="form-control"
                        placeholder="Type to search, if not found press enter to add new item..." />
                </div>
                <div id="selected-comorbidities" class="mt-2"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Does the patient have a family history of HS?</label>
                <div class="form-check">
                    <input type="checkbox" id="family_history" class="form-check-input" name="family_history">
                    <label class="form-check-label" for="family_history">Yes</label>
                </div>
                <div id="familyContainer" style="display: none;">
                    <label class="form-label">Family Member Contact Information</label>
                    <div class="form-group">
                        <label for="familyRelation">Relation</label>
                        <input type="text" class="form-control" id="familyRelation" placeholder="Relation to Patient">
                    </div>
                    <div class="form-group">
                        <label for="familyEmail">Email</label>
                        <input type="email" class="form-control" id="familyEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label for="familyAddress">Address</label>
                        <input type="text" class="form-control" id="familyAddress" placeholder="1234 Main St">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="familyCity">City</label>
                            <input type="text" class="form-control" id="familyCity">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="familyState">State</label>
                            <input list="states" id="familyState" name="familyState" class=form-control />
                            <datalist id="states">
                                <option value="AL">
                                <option value="AK">
                                <option value="AZ">
                                <option value="AR">
                                <option value="CA">
                                <option value="CO">
                                <option value="CT">
                                <option value="DE">
                                <option value="FL">
                                <option value="GA">
                                <option value="HI">
                                <option value="ID">
                                <option value="IL">
                                <option value="IN">
                                <option value="IA">
                                <option value="KS">
                                <option value="KY">
                                <option value="LA">
                                <option value="ME">
                                <option value="MD">
                                <option value="MA">
                                <option value="MI">
                                <option value="MN">
                                <option value="MS">
                                <option value="MO">
                                <option value="MT">
                                <option value="NE">
                                <option value="NV">
                                <option value="NH">
                                <option value="NJ">
                                <option value="NM">
                                <option value="NY">
                                <option value="NC">
                                <option value="ND">
                                <option value="OH">
                                <option value="OK">
                                <option value="OR">
                                <option value="PA">
                                <option value="RI">
                                <option value="SC">
                                <option value="SD">
                                <option value="TN">
                                <option value="TX">
                                <option value="UT">
                                <option value="VT">
                                <option value="VA">
                                <option value="WA">
                                <option value="WV">
                                <option value="WI">
                                <option value="WY">
                            </datalist>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="familyZip">Zip</label>
                            <input type="text" class="form-control" id="familyZip">
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="familyNotes">Notes</label>
                        <input type="text" class="form-control" id="familyNotes" name="familyNotes">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="current_hs_meds">Select Current HS Medications (tap to remove)</label>
                <div class="suggestions-container">
                    <input type="text" id="current_hs_meds" class="form-control"
                        placeholder="Type to search, if not found press enter to add new item..." />
                </div>
                <div id="selected-curr-hs-meds" class="mt-2"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="disc_hs_meds">Select Discontinued HS Medications (tap to remove)</label>
                <div class="suggestions-container">
                    <input type="text" id="disc_hs_meds" class="form-control"
                        placeholder="Type to search, if not found press enter to add new item..." />
                </div>
                <div id="selected-disc-hs-meds" class="mt-2"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Is the patient on a biologic?</label>
                <div class="form-check">
                    <input type="checkbox" id="biologics_history" class="form-check-input">
                    <label class="form-check-label" for="biologics_history">Yes</label>
                </div>
                <div class="mb-3" id="biologicsContainer" style="display: none;">
                    <label class="form-label" for="biologics_list">Name/Type of Biologic (tap to remove)</label>
                    <div>
                        <input type="text" id="biologics_list" class="form-control" placeholder="Type to search..." />
                    </div>
                    <div id="selected-biologics" class="mt-2"></div>
                    <label class="form-label" for="biologics_response">Effect of biologic treatment on patient HS
                        condition</label>
                    <select class="form-control" id="biologics_response" name="biologics_response">
                        <option value="" disabled selected>Select Option</option>
                        <option value="improve">Improve</option>
                        <option value="no_change">No Change</option>
                        <option value="worsen">Worsening</option>
                    </select>
                    <input type="text" class="form-control" id="suggestionBox" name="suggestionBox"
                        placeholder="Describe lesion changes if any...">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Any surgeries/procedures for HS lesions?</label>
                <div class="form-check">
                    <input type="checkbox" id="procedures_history_check" class="form-check-input">
                    <label class="form-check-label" class="form-control" for="procedures_history_check">Yes</label>
                </div>
                <div class="mb-3" id="proceduresContainer" style="display: none;">
                    <input type="text" id="procedures_history" class="form-control" placeholder="Explain..">
                </div>
            </div>





            <!-- Text Box with Suggestions -->
            <div class="form-group">
                <label for="other_notes">Other Notes (Optional)</label>
                <input type="text" class="form-control" id="other_notes" name="other_notes"
                    placeholder="Type something...">
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <!-- jQuery, Bootstrap JS, and jQuery UI -->
    <script src="./resources/js/jquery-3.5.1.min.js"></script>
    <script src="./resources/js/jquery-ui.min.js"></script>
    <script src="./resources/js/bootstrap.min.js"></script>
    <script src="./resources/js/crypto-js.min.js"></script>

    <!-- load medicines list -->
    <script src="./resources/js/constants.js"></script>

    <!-- hidden questions -->
    <script>
        const smokingHistoryCheckbox = document.getElementById('smoking_history');
        const packHistoryContainer = document.getElementById('packHistoryContainer');
        const biologicCheckbox = document.getElementById('biologics_history');
        const biologicsContainer = document.getElementById('biologicsContainer');
        const proceduresCheckbox = document.getElementById('procedures_history_check');
        const proceduresContainer = document.getElementById('proceduresContainer');
        const familyContainer = document.getElementById('familyContainer');
        const familyCheckbox = document.getElementById('family_history');
        const sexBox = document.getElementById('sex');
        const canvas = document.getElementById('body_map');
        const ctx = canvas.getContext("2d");
        const lesionTable = document.getElementById('lesion_table');
        var bodyImage = "";
        var lesioncountsdict = { "axillae": 0, "groin": 0, "buttocks": 0, "inframammary": 0, "perianal": 0, "genital": 0, "innerthigh": 0, "other": 0 };
        const male_polygons = {
            "Axillae1": [[100, 130], [118, 203], [83, 204]],
            "Axillae2": [[214, 132], [198, 198], [232, 201]],
            "Groin": [[131, 249], [189, 249], [168, 278], [146, 278]],
            "Buttocks": [[406, 237], [458, 250], [509, 238], [518, 284], [459, 287], [401, 275]],
            "Inframammary": [[105, 153], [209, 153], [201, 176], [111, 175]],
            "Perianal": [[452, 239], [469, 240], [466, 248], [454, 249]],
            "Genital": [[146, 279], [170, 280], [167, 294], [147, 293]],
            "InnerThigh1": [[147, 297], [154, 297], [143, 391], [130, 389]],
            "InnerThigh2": [[158, 297], [169, 297], [178, 395], [170, 395]],
            "InnerThigh3": [[447, 289], [458, 291], [447, 380], [435, 375]],
            "InnerThigh4": [[461, 291], [471, 382], [488, 381], [473, 289]],
            "Axillae3": [[400, 140], [421, 198], [385, 202]],
            "Axillae4": [[517, 138], [500, 202], [536, 204]]
        }

        const female_polygons = {
            "Axillae1": [[119, 131], [134, 135], [133, 208], [112, 204]],
            "Axillae2": [[212, 133], [225, 127], [234, 213], [214, 212]],
            "Axillae3": [[427, 131], [439, 132], [443, 204], [422, 204]],
            "Axillae4": [[521, 135], [534, 133], [538, 210], [519, 208]],
            "Groin": [[149, 251], [201, 251], [195, 273], [161, 273]],
            "Buttocks": [[426, 244], [480, 261], [536, 249], [543, 295], [494, 302], [480, 289], [469, 302], [416, 283]],
            "Perianal": [[472, 248], [490, 249], [487, 259], [474, 259]],
            "Genital": [[161, 276], [194, 275], [193, 293], [163, 292]],
            "InnerThigh1": [[159, 298], [145, 427], [167, 426], [175, 300]],
            "InnerThigh2": [[178, 300], [194, 298], [200, 437], [182, 430]],
            "InnerThigh3": [[461, 304], [474, 305], [465, 419], [456, 417]],
            "InnerThigh4": [[487, 307], [501, 305], [504, 421], [494, 421]],
            "Inframammary": [[134, 169], [174, 155], [212, 172], [212, 184], [134, 181]]

        }
        var gender = "";
        var response = "";
        var polygon_dict = {}

        smokingHistoryCheckbox.addEventListener('change', function () {
            if (this.checked) {
                packHistoryContainer.style.display = 'block'; // Show pack history input if checkbox is checked
            } else {
                packHistoryContainer.style.display = 'none'; // Hide it if unchecked
            }
        });

        familyCheckbox.addEventListener('change', function () {
            if (this.checked) {
                familyContainer.style.display = 'block';
            }
            else {
                familyContainer.style.display = 'none';
            }
        });


        biologicCheckbox.addEventListener('change', function () {
            if (this.checked) {
                biologicsContainer.style.display = 'block'; // Show pack history input if checkbox is checked
            } else {
                biologicsContainer.style.display = 'none'; // Hide it if unchecked
            }
        });

        proceduresCheckbox.addEventListener('change', function () {
            if (this.checked) {
                proceduresContainer.style.display = 'block'; // Show pack history input if checkbox is checked
            } else {
                proceduresContainer.style.display = 'none'; // Hide it if unchecked
            }
        });

        function drawImage(gender_) {
            if (gender_ == "male") {
                bodyImage = new Image(600, 554);
                canvas.height = bodyImage.height;
                canvas.width = bodyImage.width;
                bodyImage.onload = drawImageActualSize;
                bodyImage.src = "./resources/img/male.png";
            }
            if (gender_ == "female") {
                bodyImage = new Image(600, 554);
                canvas.height = bodyImage.height;
                canvas.width = bodyImage.width;
                bodyImage.onload = drawImageActualSize;
                bodyImage.src = "./resources/img/female.png";
            }

        }

        function drawImageActualSize() {
            //canvas.width = this.naturalWidth;
            //canvas.height = this.naturalHeight;
            ctx.drawImage(this, 0, 0, this.width, this.height);
            drawPolygons();
        }

        sexBox.addEventListener('change', function () {
            console.log("changed sex");
            var tableHeight = lesionTable.offsetHeight;
            if (this.value.trim().toLowerCase() == "male") {
                console.log("male");
                gender = "male";
                drawImage(gender);
            }
            else if (this.value.trim().toLowerCase() == "female") {
                console.log("female");
                gender = "female";
                drawImage(gender);
            }
            else {
                return;
            }

        });

        function drawPolygon(points, key) {
            ctx.beginPath();
            ctx.moveTo(points[0][0], points[0][1]);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i][0], points[i][1]);
            }
            ctx.closePath();

            if (key.startsWith("Axillae")) {
                ctx.fillStyle = "rgba(127,128,0,0.5)"
            }
            if (key.startsWith("Groin")) {
                ctx.fillStyle = "rgba(255,0,0,0.5)"
            }
            if (key.startsWith("Buttocks")) {
                ctx.fillStyle = "rgba(214,15,141,0.5)"
            }
            if (key.startsWith("Inframammary")) {
                ctx.fillStyle = "rgba(50,255,0,0.5)"
            }
            if (key.startsWith("Perianal")) {
                ctx.fillStyle = "rgba(20,255,255,0.5)"
            }
            if (key.startsWith("Genital")) {
                ctx.fillStyle = "rgba(0,0,255,0.5)"
            }
            if (key.startsWith("InnerThigh")) {
                ctx.fillStyle = "rgba(28,144,255,0.5)"
            }
            ctx.fill();
            ctx.stroke();

        }

        // Function to draw all polygons on the canvas
        async function drawPolygons() {
            if (gender == "male") {
                for (const key in male_polygons) {
                    drawPolygon(male_polygons[key], key);
                }
            }
            if (gender == "female") {
                for (const key in female_polygons) {
                    drawPolygon(female_polygons[key], key);
                }
            }
        }

        // Point-in-polygon function
        function isPointInPolygon(point, polygon) {
            let x = point[0], y = point[1];
            let inside = false;

            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];

                const intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        // Update counters on the page
        function updateCounters() {
            document.getElementById("axillae").value = lesioncountsdict["axillae"];
            document.getElementById("groin").value = lesioncountsdict["groin"];
            document.getElementById("buttocks").value = lesioncountsdict["buttocks"];
            document.getElementById("perianal").value = lesioncountsdict["perianal"];
            document.getElementById("inframammary").value = lesioncountsdict["inframammary"];
            document.getElementById("genital").value = lesioncountsdict["genital"];
            document.getElementById("inner_thigh").value = lesioncountsdict["innerthigh"];
            document.getElementById("other").value = lesioncountsdict["other"];
        }

        // Check which body part is clicked based on coordinates
        function checkBodyPart(x, y) {
            const point = [x, y];
            var validpoint = false;
            if (gender == "male") {
                for (const key in male_polygons) {
                    if (isPointInPolygon(point, male_polygons[key])) {
                        var key_str = key.replace(/[0-9]/g, '').toLowerCase();
                        lesioncountsdict[key_str] += 1;
                        validpoint = true;
                        break;
                    }
                }
            }
            if (gender == "female") {
                for (const key in female_polygons) {
                    if (isPointInPolygon(point, female_polygons[key])) {
                        var key_str = key.replace(/[0-9]/g, '').toLowerCase();
                        lesioncountsdict[key_str] += 1;
                        validpoint = true;
                        break;
                    }
                }
            }
            if (!validpoint) {
                lesioncountsdict["other"] += 1;
            }
            updateCounters();
        }

        function clearCounts() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawImage(gender);
            drawPolygons();
            lesioncountsdict = { "axillae": 0, "groin": 0, "buttocks": 0, "inframammary": 0, "perianal": 0, "genital": 0, "innerthigh": 0, "other": 0 };
            updateCounters();

        }

        // Handle canvas click event
        canvas.addEventListener("click", function (event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            console.log(x, y);

            // Mark the clicked point on the canvas
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2);
            ctx.fillStyle = "red";
            ctx.fill();

            // Check which body part was clicked
            checkBodyPart(x, y);
        });

        document.getElementById('clear_body_map').addEventListener('click', function () {
            // Clear the body map or perform other actions
            console.log('Clear Body Map button clicked');
            // Example: Clear the canvas
            clearCounts();
        });

    </script>

    <script>
        // Auto-suggestions for the text box
        const form = document.getElementById('dataForm');

        // don't auto submit with enter keypress
        form.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
            }
        });


        // Handle form submission and convert data to JSON
        $("#dataForm").submit(function (event) {
            event.preventDefault(); // Prevent the default form submission

            if ($("#family_history").is(":checked")) {
                var family_history_list = {
                    relation: $("familyRelation").val(),
                    email: $("familyEmail").val(),
                    address: $("familyAddress").val(),
                    city: $("familyCity").val(),
                    state: $("familyState").val(),
                    zip: $("familyZip").val()
                };
            }
            else {
                var family_history_list = {};
            }

            var userInput = prompt("Please enter the MRN to confirm:");
            var mrnValue = $("#mrn").val();
            if (userInput !== null) { // Check if the user didn't cancel the prompt
                if (userInput.trim() === mrnValue) {
                    // If numbers match, you can proceed to submit the form or do whatever is needed
                    alert("Numbers match. Submitting the form...");
                    // Collect form data
                    var formData = {
                        disease_state: $("#disease_state").val(),
                        enrollment_number: $("#enrollment_number").val(),
                        first_name: $("#first_name").val(),
                        last_name: $("#last_name").val(),
                        MRN: $("#mrn").val(),
                        dob: $("#dob").val(),
                        race: $("#race").val(),
                        sex: $("#sex").val(),
                        bmi: $("#bmi").val(),
                        hurley: $("#hurley").val(),
                        axillae: $("#axillae").val(),
                        groin: $("#groin").val(),
                        buttocks: $("#buttocks").val(),
                        inframammary: $("#inframammary").val(),
                        perianal: $("#perianal").val(),
                        genital: $("#genital").val(),
                        inner_thigh: $("#inner_thigh").val(),
                        other: $("#other").val(),
                        family_history: $("#family_history").is(":checked"),
                        family_contact: family_history_list,
                        smoking_history: $("#smoking_history").is(":checked"),
                        pack_history: $("#packHistory").val(),

                        comorbidities: comorbiditiesList, // Assuming this will hold selected comorbidities
                        current_hs_meds: currentMedsList, // Assuming this will hold selected current meds
                        disc_hs_meds: discontinuedMedsList, // Assuming this will hold selected discontinued meds
                        biologics_history: $("#biologics_history").is(":checked"),
                        biologics_list: biologicsList,
                        biologics_response: $("#biologics_response").val(),
                        procedures_history_check: $("#procedures_history_check").is(":checked"),
                        procedures_history: $("#procedures_history").val(),
                        other_notes: $("#other_notes").val(),
                        suggestionBox: $("#suggestionBox").val()
                    };

                    // Convert form data to JSON
                    var jsonData = JSON.stringify(formData, null, 4);

                    var blob = new Blob([jsonData], { type: 'application/json' });
                    var url = URL.createObjectURL(blob);

                    // Create a link element to trigger the download
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = `${mrnValue}.json`; // Set the file name to MRN value
                    document.body.appendChild(a); // Append to the body
                    a.click(); // Trigger the download
                    document.body.removeChild(a); // Remove the link


                    /* issue with encryption is that secret key can only be obfuscated since
                    all the code exists locally. probably not worth the hassle of having people
                    use aes to decrypt vs the security benefit.
                    // Display JSON in the output div
                    $("#jsonOutput").text(jsonData);
    
                    var secretKey = "your-secret-key"; // Replace with your secret key
                    var encryptedData = CryptoJS.AES.encrypt(jsonData, secretKey).toString();
                    */
                }
                else {
                    alert("The number you entered does not match the MRN field.");
                }
            }
            else {
                alert("You did not enter anything.");
            }
        });
    </script>

    <script>
        var discontinuedMedsList = [];
        var currentMedsList = [];
        var biologicsList = [];
        var comorbiditiesList = [];

        $(function () {


            $("#comorbidities").autocomplete({
                source: comorbidities,
                minLength: 1,
                select: function (event, ui) {
                    var selected = ui.item.value;
                    addComorbidity(selected);
                    this.value = ''; // Clear the input field
                    return false;
                }
            });

            $("#comorbidities").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    var customTag = this.value.trim();
                    if (customTag && !comorbidities.includes(customTag)) {
                        addComorbidity(customTag);
                        this.value = ''; // Clear the input field
                    }
                    e.preventDefault(); // Prevent form submission
                }
            });

            function addComorbidity(comorbidity) {
                var currentComorbidities = $('#selected-comorbidities').text();
                if (!currentComorbidities.includes(comorbidity)) {
                    $('#selected-comorbidities').append('<span class="badge bg-secondary me-1 comorbidity-item">' + comorbidity + '</span>');
                    comorbiditiesList.push(comorbidity);
                }
            }

            $(document).on('click', '.comorbidity-item', function () {
                var comorbidity = $(this).text().trim(); // Get the text value
                $(this).remove(); // Remove the span
                var index = comorbiditiesList.indexOf(comorbidity);
                if (index > -1) {
                    comorbiditiesList.splice(index, 1); // Remove comorbidity from the list
                }
            });
        });
    </script>

    <script>
        $(function () {

            $("#current_hs_meds").autocomplete({
                source: hsMedications,
                minLength: 1,
                select: function (event, ui) {
                    var selected = ui.item.value;
                    addCurrMed(selected);
                    this.value = ''; // Clear the input field
                    return false;
                }
            });

            $("#current_hs_meds").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    var customTag = this.value.trim();
                    if (customTag && !hsMedications.includes(customTag)) {
                        addCurrMed(customTag);
                        this.value = ''; // Clear the input field
                    }
                    e.preventDefault(); // Prevent form submission
                }
            });

            function addCurrMed(med) {
                var CurrMed = $('#selected-curr-hs-meds').text();
                if (!CurrMed.includes(med)) {
                    $('#selected-curr-hs-meds').append('<span class="badge bg-secondary me-1 currmed-item">' + med + '</span>');
                    currentMedsList.push(med);
                }
            }

            $(document).on('click', '.currmed-item', function () {
                var currmed = $(this).text().trim(); // Get the text value
                $(this).remove(); // Remove the span
                var index = currentMedsList.indexOf(currmed);
                if (index > -1) {
                    currentMedsList.splice(index, 1);
                }
            });
        });
    </script>

    <script>
        $(function () {
            $("#disc_hs_meds").autocomplete({
                source: hsMedications,
                minLength: 1,
                select: function (event, ui) {
                    var selected = ui.item.value;
                    addDiscMed(selected);
                    this.value = ''; // Clear the input field
                    return false;
                }
            });

            $("#disc_hs_meds").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    var customTag = this.value.trim();
                    if (customTag && !hsMedications.includes(customTag)) {
                        addDiscMed(customTag);
                        this.value = ''; // Clear the input field
                    }
                    e.preventDefault(); // Prevent form submission
                }
            });

            function addDiscMed(med) {
                var CurrMed = $('#selected-disc-hs-meds').text();
                if (!CurrMed.includes(med)) {
                    $('#selected-disc-hs-meds').append('<span class="badge bg-secondary me-1 discmed-item">' + med + '</span>');
                    discontinuedMedsList.push(med);
                }
            }

            $(document).on('click', '.discmed-item', function () {
                var discmed = $(this).text().trim(); // Get the text value
                $(this).remove(); // Remove the span
                var index = discontinuedMedsList.indexOf(discmed);
                if (index > -1) {
                    discontinuedMedsList.splice(index, 1);
                }
            });
        });
    </script>

    <script>
        $(function () {
            $("#biologics_list").autocomplete({
                source: hsBiologics,
                minLength: 1,
                select: function (event, ui) {
                    var selected = ui.item.value;
                    addBiologic(selected);
                    this.value = ''; // Clear the input field
                    return false;
                }
            });

            $("#biologics_list").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    var customTag = this.value.trim();
                    if (customTag && !hsMedications.includes(customTag)) {
                        addBiologic(customTag);
                        this.value = ''; // Clear the input field
                    }
                    e.preventDefault(); // Prevent form submission
                }
            });

            function addBiologic(med) {
                var CurrMed = $('#selected-biologics').text();
                if (!CurrMed.includes(med)) {
                    $('#selected-biologics').append('<span class="badge bg-secondary me-1 biologic-item">' + med + '</span>');
                    biologicsList.push(med);
                }
            }

            $(document).on('click', '.biologic-item', function () {
                var bio_item = $(this).text().trim(); // Get the text value
                $(this).remove(); // Remove the span
                var index = biologicsList.indexOf(bio_item);
                if (index > -1) {
                    biologicsList.splice(index, 1);
                }
            });
        });
    </script>


</body>

</html>